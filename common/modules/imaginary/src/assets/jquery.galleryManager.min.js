(function(C){"use strict";var L={csrfToken:C("meta[name=csrf-token]").attr("content"),csrfTokenName:C("meta[name=csrf-param]").attr("content"),nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function a(e,a){var r=C.extend({},L,a);var t=r.csrfToken?"&"+r.csrfTokenName+"="+r.csrfToken:"";var l={};var i=C(e);if(!r.hasName){if(!r.hasDesc){i.addClass("no-name-no-desc");C(".edit_selected",i).hide()}else i.addClass("no-name")}else if(!r.hasDesc)i.addClass("no-desc");var n=C(".sorter",i);var c=C(".images",n);var d=C(".editor-modal",i);var p=C(".error-overlay",i);var f=C(".progress-overlay",i);var h=C(".upload-progress",f);var v=C(".form",d);function u(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function m(e,a,t,s){var o='<div class="photo-editor row">'+'<div class="col-xs-4">'+'<img src="'+u(a)+'"  style="max-width:100%;">'+"</div>"+'<div class="col-xs-8">'+(r.hasName?'<div class="form-group">'+'<label class="control-label" for="photo_name_'+e+'">'+r.nameLabel+":</label>"+'<input class="form-control" type="text" name="photo['+e+'][name]" class="input-xlarge" value="'+u(t)+'" id="photo_name_'+e+'"/>'+"</div>":"")+(r.hasDesc?'<div class="form-group">'+'<label class="control-label" for="photo_description_'+e+'">'+r.descriptionLabel+":</label>"+'<textarea class="form-control" name="photo['+e+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+e+'">'+u(s)+"</textarea>"+"</div>":"")+"</div>"+"</div>";return C(o)}var g='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(r.hasName){g+="<h5></h5>"}if(r.hasDesc){g+="<p></p>"}g+='</div><div class="actions">';if(r.hasName||r.hasDesc){g+='<span class="editPhoto btn btn-primary btn-xs"><i class="glyphicon glyphicon-pencil glyphicon-white"></i></span> '}g+='<span class="deletePhoto btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';function k(e,a,t,s,o){var n=C(g);l[e]=n;n.data("id",e);n.data("rank",o);C("img",n).attr("src",a);if(r.hasName){C(".caption h5",n).text(t)}if(r.hasDesc){C(".caption p",n).text(s)}c.append(n);return n}function D(e){var a=e.length;var t=v.empty();for(var s=0;s<a;s++){var o=e[s];var n=l[o],r=C("img",n).attr("src"),i=C(".caption h5",n).text(),c=C(".caption p",n).text();t.append(m(o,r,i,c))}if(a>0){d.modal("show")}}function s(s){C.ajax({type:"POST",url:r.deleteUrl,data:"id[]="+s.join("&id[]=")+t,success:function(e){if(e=="OK"){for(var a=0,t=s.length;a<t;a++){l[s[a]].remove();delete l[s[a]]}}else{alert(e)}}})}function o(e){e.preventDefault();var a=C(this).closest(".photo");var t=a.data("id");s([t]);return false}function x(e){e.preventDefault();var a=C(this).closest(".photo");var t=a.data("id");D([t]);return false}function b(){var e=C(".photo.selected",n).length;C(".select_all",i).prop("checked",C(".photo",n).length==e);if(e==0){C(".edit_selected, .remove_selected",i).addClass("disabled")}else{C(".edit_selected, .remove_selected",i).removeClass("disabled")}}function y(){var e=C(this);if(e.is(":checked"))e.closest(".photo").addClass("selected");else e.closest(".photo").removeClass("selected");b()}c.on("click",".photo .deletePhoto",o).on("click",".photo .editPhoto",x).on("click",".photo .photo-select",y);C(".images",n).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var a=[];C(".photo",n).each(function(){var e=C(this);a.push("order["+e.data("id")+"]="+e.data("rank"))});C.ajax({type:"POST",url:r.arrangeUrl,data:a.join("&")+t,dataType:"json"}).done(function(e){for(var a in e[a]){l[a].data("rank",e[a])}})});if(window.FormData!==undefined){var w=C(".afile",i).attr("name");var T=function(e){if(e.length==0)return;f.show();h.css("width","5%");var s=e.length;var o=0;var n=[];for(var a=0;a<s;a++){var t=new FormData;t.append(w,e[a]);if(r.csrfToken){t.append(r.csrfTokenName,r.csrfToken)}C.ajax({type:"POST",url:r.uploadUrl,data:t,processData:false,contentType:false}).done(function(e,a,t){o++;k(e["id"],e["preview"],e["name"],e["description"],e["rank"]);n.push(e["id"]);h.css("width",""+(5+95*o/s)+"%");if(o===s){h.css("width","100%");f.hide();if(r.hasName||r.hasDesc)D(n)}}).fail(function(e,a,t){f.hide();p.show();setTimeout(function(){p.fadeOut()},5e3);console.log(a,t)})}};(function(){var e=i[0];var t=false;var a=false;setInterval(function(){if(t!=a){if(t)e.classList.add("over");else e.classList.remove("over");a=t}},30);function s(e){e.preventDefault();t=true;return false}function o(){t=false;return false}function n(e){e.preventDefault();e.stopPropagation();var a=e.dataTransfer.files;T(a);t=false;return false}function r(){t=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",o,false);e.addEventListener("drop",n,false);e.addEventListener("dragend",r,false)})();C(".afile",i).attr("multiple","true").on("change",function(e){e.preventDefault();T(this.files);C(this).val(null)})}else{C(".afile",i).on("change",function(e){e.preventDefault();var a=[];f.show();h.css("width","5%");var t={};if(r.csrfToken)t[r.csrfTokenName]=r.csrfToken;C.ajax({type:"POST",url:r.uploadUrl,data:t,files:C(this),iframe:true,processData:false,dataType:"json"}).done(function(e){k(e["id"],e["preview"],e["name"],e["description"],e["rank"]);a.push(e["id"]);h.css("width","100%");f.hide();if(r.hasName||r.hasDesc)D(a)})})}C(".save-changes",d).click(function(e){e.preventDefault();C.post(r.updateUrl,C("input, textarea",v).serialize()+t,function(e){var a=e.length;for(var t=0;t<a;t++){var s=e[t];var o=l[s.id];C("img",o).attr("src",s["src"]);if(r.hasName)C(".caption h5",o).text(s["name"]);if(r.hasDesc)C(".caption p",o).text(s["description"])}d.modal("hide");C(".photo.selected",n).each(function(){C(".photo-select",this).prop("checked",false)}).removeClass("selected");C(".select_all",i).prop("checked",false);b()},"json")});C(".edit_selected",i).click(function(e){e.preventDefault();var a=[];C(".photo.selected",n).each(function(){a.push(C(this).data("id"))});D(a);return false});C(".remove_selected",i).click(function(e){e.preventDefault();var a=[];C(".photo.selected",n).each(function(){a.push(C(this).data("id"))});s(a)});C(".select_all",i).change(function(){if(C(this).prop("checked")){C(".photo",n).each(function(){C(".photo-select",this).prop("checked",true)}).addClass("selected")}else{C(".photo.selected",n).each(function(){C(".photo-select",this).prop("checked",false)}).removeClass("selected")}b()});for(var _=0,N=r.photos.length;_<N;_++){var j=r.photos[_];k(j["id"],j["preview"],j["name"],j["description"],j["rank"])}}C.fn.galleryManager=function(e){if(this.length){this.each(function(){a(this,e)})}}})(jQuery);